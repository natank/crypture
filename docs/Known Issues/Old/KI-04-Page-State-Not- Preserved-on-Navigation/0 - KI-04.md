# Navigation State Preservation Analysis & Design
Ref docs: `1 - Current State Analysis.md`, `2 - Phase 2.md`
I need you to help solve the issue described in KI-04 (Page State Not Preserved on Navigation, reference bello). 

**IMPORTANT: Do NOT jump to implementation. Follow this structured process:**

## DONE - Phase 1: Analysis & Discovery (STOP for review after this)

1. **Current State Analysis**
   - Examine the current routing setup (React Router configuration)
   - Identify all components involved in the navigation flow:
     * Portfolio Dashboard component
     * Coin Details component  
     * Any layout/wrapper components
   - Document the current state management approach for:
     * Scroll position
     * Filter text
     * Sort options
   - Map the data flow and identify where state is currently held

2. **Problem Characterization**
   - What exactly is being lost and why?
   - At what point in the navigation lifecycle does state loss occur?
   - Are there any existing patterns in the codebase for state preservation?

**DELIVERABLE:** Provide a detailed analysis report. **WAIT for my review before proceeding.**

---

## Phase 2: Trade Study (STOP for review after this)

Compare at least 3-4 different approaches for solving this problem:

For each approach, analyze:
- **Implementation complexity** (LOC estimate, files to modify)
- **Pros & Cons**
- **Performance implications**
- **Future scalability** (what happens when we add global state later?)
- **Testing requirements**
- **Migration path** (how disruptive to existing code?)

Consider these candidate approaches (but find others if relevant):
1. React Router location state
2. Session Storage
3. URL query parameters
4. React Context (lightweight, just for navigation state)
5. History state API
6. Scroll Restoration API + custom state management

**DELIVERABLE:** Provide a trade study matrix comparing approaches. Include your recommendation with rationale. **WAIT for my review before proceeding.**

---

## Phase 3: Detailed Design (STOP for review after this)

Based on the approved approach, create:

1. **Architecture Diagram**
   - Component relationships
   - Data flow for state preservation/restoration
   - Lifecycle hooks involved

2. **Implementation Plan**
   - Files to modify (with specific changes)
   - New files to create
   - Dependencies to add (if any)

3. **State Schema**
   - What exactly needs to be preserved?
   - Data structure/interface definitions

4. **Edge Cases & Handling**
   - What happens on direct URL navigation?
   - Browser back/forward button behavior
   - Page refresh behavior
   - Modal state conflicts

5. **Testing Strategy**
   - E2E test scenarios (Playwright)
   - Unit test requirements
   - Manual testing checklist

**DELIVERABLE:** Provide complete design documentation. **WAIT for my final approval before implementation.**

---

## Constraints & Requirements

- No global state library yet (no Redux, Zustand, etc.)
- Must work with existing React Router setup
- Should not break any existing functionality
- Must handle all AC items in KI-04
- Solution should be maintainable and well-documented
- Consider TypeScript type safety throughout

## Output Format

For each phase, provide:
- Clear section headers
- Code snippets for current state (Phase 1)
- Comparison tables (Phase 2)
- Diagrams using mermaid syntax (Phase 3)
- Specific file paths and line references

**Remember: STOP at the end of each phase and wait for my explicit approval to continue.**

## Reference: KI-04

### KI-04: Page State Not Preserved on Navigation

**Screen:** Portfolio Dashboard → Coin Details → Back  
**Category:** Navigation / UX  
**Priority:** Must Have  
**Effort:** High (4-6 hours)

**Current Behavior:**
- Navigating from portfolio to coin details and back loses:
  - Scroll position
  - Filter/sort state

- User must re-find their place in the asset list

**Acceptance Criteria:**
- [ ] Scroll position restored when navigating back
- [ ] Filter text preserved
- [ ] Sort option preserved
- [ ] Modal states handled correctly (no ghost modals)

**Technical Notes:**
- Use `useLocation` state or session storage
- Consider React Router's `ScrollRestoration`
- May need to lift filter/sort state to context or URL params

---
